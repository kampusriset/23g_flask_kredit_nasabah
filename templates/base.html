<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SIPINA - {% block title %}{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/custom.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/palette.css') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SIPINA">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='assets/img/icon-192x192.png') }}">
    {% block head %}{% endblock %}
    <meta name="csrf-token" content="{{ csrf_token() }}" />
  </head>
  <body>
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="{{ url_for('dashboard.index') if current_user.is_authenticated else url_for('auth.login') }}" class="sidebar-logo">
          <i class="bi bi-bank2"></i>
          <span>SIPINA</span>
        </a>
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
          <i class="bi bi-chevron-left"></i>
        </button>
      </div>

      {% if current_user.is_authenticated %}
        <!-- User Profile Section -->
        <div class="sidebar-profile">
          <div class="profile-avatar">
            {% if current_user.foto_profil %}
              <img src="{{ url_for('static', filename=current_user.foto_profil) }}"
                   alt="Profile"
                   class="avatar-logo"
                   onerror="this.src='{{ url_for('static', filename='assets/img/default-user.svg') }}'" />
            {% else %}
              <img src="{{ url_for('static', filename='assets/img/default-user.svg') }}"
                   alt="Profile"
                   class="avatar-logo" />
            {% endif %}
          </div>
          <div class="profile-info">
            <div class="profile-name">
              {% if current_user.role == 'nasabah' %}
                {% set nasabah = current_user.nasabah %}
                {{ nasabah.nama if nasabah else current_user.username }}
              {% else %}
                {{ current_user.username }}
              {% endif %}
            </div>
            <div class="profile-role">{{ current_user.role.upper() }}</div>
          </div>
        </div>

        <!-- Navigation Menu -->
        <nav class="sidebar-nav">
          <a href="{{ url_for('dashboard.index') }}" class="nav-item">
            <i class="bi bi-speedometer2"></i>
            <span>Dashboard</span>
          </a>

          {% if current_user.role == 'admin' %}
            <a href="{{ url_for('nasabah.index') }}" class="nav-item">
              <i class="bi bi-people"></i>
              <span>Nasabah</span>
            </a>
            <a href="{{ url_for('pengajuan.index') }}" class="nav-item">
              <i class="bi bi-file-earmark-text"></i>
              <span>Pengajuan</span>
            </a>
            <a href="{{ url_for('dashboard.analytics') }}" class="nav-item">
              <i class="bi bi-graph-up"></i>
              <span>Analytics</span>
            </a>
            <a href="{{ url_for('notifikasi.index') }}" class="nav-item">
              <i class="bi bi-bell"></i>
              <span>Notifikasi</span>
            </a>
            <a href="{{ url_for('user.index') }}" class="nav-item">
              <i class="bi bi-people-fill"></i>
              <span>Users</span>
            </a>

          {% else %}
            <a href="{{ url_for('pengajuan.index') }}" class="nav-item">
              <i class="bi bi-file-earmark-text"></i>
              <span>Pengajuan</span>
            </a>
          {% endif %}
        </nav>

        <!-- Logout Section -->
        <div class="sidebar-footer">
          <a href="{{ url_for('auth.logout') }}" class="nav-item logout-item">
            <i class="bi bi-box-arrow-right"></i>
            <span>Logout</span>
          </a>
        </div>
      {% endif %}
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">

      <!-- ALERTS -->
      <div class="alerts-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, msg in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> {{ msg }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      </div>

      <div class="content-wrapper">
        {% block content %}{% endblock %}
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Sidebar toggle functionality
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebarToggle');
      const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');

      // Desktop sidebar toggle
      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
          const icon = sidebarToggle.querySelector('i');
          if (sidebar.classList.contains('collapsed')) {
            icon.className = 'bi bi-chevron-right';
          } else {
            icon.className = 'bi bi-chevron-left';
          }
        });
      }

      // Mobile sidebar toggle
      if (mobileSidebarToggle) {
        mobileSidebarToggle.addEventListener('click', () => {
          sidebar.classList.toggle('mobile-open');
        });
      }

      // Close mobile sidebar when clicking outside
      document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768) {
          if (!sidebar.contains(e.target) && !mobileSidebarToggle.contains(e.target)) {
            sidebar.classList.remove('mobile-open');
          }
        }
      });

      // Close mobile sidebar when clicking on nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          if (window.innerWidth <= 768) {
            sidebar.classList.remove('mobile-open');
          }
        });
      });

      // Handle window resize
      window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
          sidebar.classList.remove('mobile-open');
        }
      });

      // PWA Service Worker Registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/static/sw.js')
            .then(registration => {
              console.log('SW registered: ', registration);
            })
            .catch(registrationError => {
              console.log('SW registration failed: ', registrationError);
            });
        });
      }
    </script>
  </body>
</html>


